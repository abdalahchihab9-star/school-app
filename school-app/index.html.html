<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box;}
        body { 
            font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; 
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); 
            min-height:100vh; 
            padding:20px; 
            color:#333;
            transition: all 0.3s ease;
        }
        [dir="ltr"] { direction: ltr; }
        [dir="rtl"] { direction: rtl; }
        .container { 
            max-width:1400px; 
            margin:0 auto; 
            background:white; 
            border-radius:15px; 
            box-shadow:0 10px 40px rgba(0,0,0,0.2); 
            overflow:hidden;
        }
        .header { 
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); 
            color:white; 
            padding:30px 20px; 
            text-align:center; 
            border-bottom:5px solid #333;
            position: relative;
        }
        .header h1 { 
            font-size:clamp(20px, 5vw, 30px); 
            margin-bottom:10px; 
            font-weight:700;
        }
        .header p { 
            font-size:clamp(13px, 3vw, 15px); 
            opacity:0.95;
        }

        /* Language & Term Selector Bar */
        .top-bar {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .term-selector-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 250px;
        }
        .term-selector-wrapper label {
            font-size: 14px;
            font-weight: 600;
            color: white;
            white-space: nowrap;
        }
        .term-selector {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            background: white;
            color: #667eea;
            cursor: pointer;
            min-width: 180px;
        }
        .language-switcher {
            display: flex;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 5px;
            border-radius: 20px;
        }
        .lang-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 15px;
            background: transparent;
            color: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .lang-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        .lang-btn.active {
            background: white;
            color: #667eea;
        }

        .school-settings { 
            background:#f8f9fa; 
            padding:20px; 
            border-bottom:2px solid #dee2e6;
        }
        .settings-grid { 
            display:grid; 
            grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); 
            gap:15px;
        }
        .settings-input { 
            width:100%; 
            padding:12px; 
            border:2px solid #ddd; 
            border-radius:8px; 
            font-size:14px;
        }
        .save-settings-btn { 
            background:#28a745; 
            color:white; 
            padding:12px 25px; 
            border:none; 
            border-radius:8px; 
            cursor:pointer; 
            font-size:15px; 
            font-weight:600; 
            margin-top:10px;
            width: 100%;
            max-width: 300px;
        }
        .save-settings-btn:hover { background:#218838;}

        .class-management { 
            background:#fff; 
            padding:20px; 
            border-bottom:2px solid #dee2e6;
        }
        .class-controls { 
            display:flex; 
            gap:15px; 
            flex-wrap:wrap; 
            align-items:center; 
            margin-bottom:15px;
        }
        .class-selector { 
            flex:1; 
            min-width:200px; 
            padding:12px 20px; 
            border:2px solid #667eea; 
            border-radius:8px; 
            font-size:15px; 
            font-weight:600; 
            background:white; 
            color:#667eea; 
            cursor:pointer;
        }
        .add-class-section { 
            display:flex; 
            gap:10px; 
            flex-wrap:wrap; 
            padding:15px; 
            background:#f0f4ff; 
            border-radius:8px; 
            margin-top:10px;
        }
        .add-class-input { 
            padding:10px; 
            border:2px solid #667eea; 
            border-radius:6px; 
            font-size:14px; 
            flex: 1;
            min-width:200px;
        }
        .btn { 
            padding:10px 20px; 
            border:none; 
            border-radius:6px; 
            cursor:pointer; 
            font-size:14px; 
            font-weight:600; 
            transition:all 0.3s;
            white-space: nowrap;
        }
        .btn-primary { background:#667eea; color:white;}
        .btn-danger { background:#dc3545; color:white;}
        .btn-success { background:#28a745; color:white;}
        .btn-info { background:#17a2b8; color:white;}
        .btn-warning { background:#ffc107; color:#000;}
        .btn-secondary { background:#6c757d; color:white;}
        .btn-light { background:#f8f9fa; color:#333; border:1px solid #dee2e6;}

        .btn-primary:hover { background:#5568d3; }
        .btn-danger:hover { background:#c82333;}
        .btn-success:hover { background:#218838;}
        .btn-info:hover { background:#138496;}
        .btn-warning:hover { background:#e0a800;}
        .btn-secondary:hover { background:#5a6268;}
        .btn-light:hover { background:#e2e6ea;}

        .classes-list { 
            display:flex; 
            gap:8px; 
            flex-wrap:wrap; 
            margin-top:10px;
        }
        .class-tag { 
            background:#667eea; 
            color:white; 
            padding:8px 15px; 
            border-radius:20px; 
            font-size:13px; 
            display:inline-flex; 
            align-items:center; 
            gap:8px;
        }
        .class-tag button { 
            background:#fff; 
            color:#667eea; 
            border:none; 
            border-radius:50%; 
            width:20px; 
            height:20px; 
            cursor:pointer; 
            font-size:12px; 
            font-weight:bold;
        }

        .stats { 
            display:grid; 
            grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); 
            gap:15px; 
            padding:20px; 
            background:#f8f9fa;
        }
        .stat-card { 
            background:white; 
            padding:15px; 
            border-radius:10px; 
            text-align:center; 
            border-left:4px solid #667eea; 
            box-shadow:0 2px 4px rgba(0,0,0,0.1);
        }
        [dir="ltr"] .stat-card {
            border-left: none;
            border-right: 4px solid #667eea;
        }
        .stat-value { 
            font-size:clamp(22px, 4vw, 28px); 
            font-weight:700; 
            color:#667eea; 
            margin:10px 0;
        }
        .stat-label { 
            font-size:clamp(11px, 2vw, 13px); 
            color:#666; 
            text-transform:uppercase;
        }

        .controls { 
            padding:20px; 
            background:#f8f9fa; 
            display:flex; 
            gap:10px; 
            flex-wrap:wrap; 
            align-items:center; 
            border-bottom:2px solid #dee2e6;
        }
        .search-box { 
            flex:1; 
            min-width:200px;
        }
        .search-box input { 
            width:100%; 
            padding:12px; 
            border:2px solid #ddd; 
            border-radius:8px; 
            font-size:14px;
        }

        /* Filter section */
        .filter-section {
            background:#fff;
            padding:20px;
            border-bottom:2px solid #dee2e6;
        }
        .filter-section h3 {
            color:#667eea;
            margin-bottom:15px;
            font-size:16px;
            display:flex;
            align-items:center;
            gap:8px;
        }
        .filter-buttons {
            display:flex;
            gap:10px;
            flex-wrap:wrap;
        }

        .table-wrapper { 
            overflow-x:auto; 
            padding:20px;
        }
        table { 
            width:100%; 
            border-collapse:collapse; 
            margin-top:10px;
            min-width: 800px;
        }
        thead { 
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); 
            color:white; 
            font-weight:600;
        }
        th { 
            padding:15px 10px; 
            text-align:center; 
            font-size:clamp(12px, 2vw, 14px); 
            border:1px solid #dee2e6;
        }
        td { 
            padding:12px 10px; 
            text-align:center; 
            border:1px solid #dee2e6; 
            font-size:clamp(11px, 2vw, 13px);
        }
        tbody tr { transition:background-color 0.3s;}
        tbody tr:hover { background-color:#f0f4ff;}
        tbody tr:nth-child(even) { background-color:#f8f9fa;}

        .name-cell { 
            text-align:right; 
            font-weight:500; 
            color:#333;
        }
        [dir="ltr"] .name-cell {
            text-align: left;
        }

        /* Editable Score Cell - Direct Input */
        .editable-score { 
            display:inline-block; 
            min-width:50px; 
            padding:8px 10px; 
            border-radius:6px; 
            cursor:pointer; 
            transition:all 0.3s; 
            font-weight:600;
            border: 2px solid transparent;
        }
        .editable-score:hover { 
            background:#f0f4ff;
            border-color: #667eea;
        }
        .editable-score:focus {
            outline: none;
            background:#fff;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .editable-score[contenteditable="true"] {
            background: #fff;
            border-color: #667eea;
        }

        .obs-modern { 
            display:inline-flex; 
            align-items:center; 
            gap:6px; 
            border-radius:14px; 
            padding:8px 16px; 
            font-size:clamp(11px, 2vw, 13px); 
            font-weight:600;
        }
        .obs-excellent { background:linear-gradient(90deg,#43e97b 0,#38f9d7 100%); color:#003a1b;}
        .obs-verygood { background:linear-gradient(90deg,#fbc2eb 0,#a6c1ee 100%); color:#662381;}
        .obs-good { background:linear-gradient(90deg,#fad961 0,#f76b1c 100%); color:#7f3e07;}
        .obs-average { background:linear-gradient(90deg,#ffecd2 0,#fcb69f 100%); color:#af5308;}
        .obs-poor { background:linear-gradient(90deg,#ff6a6a 0,#db3434 100%); color:#fff;}
        .obs-modern i { font-style:normal; font-size:16px;}

        .action-btns { 
            display:flex; 
            gap:5px; 
            justify-content:center;
            flex-wrap: wrap;
        }
        .action-btn { 
            padding:8px 14px; 
            border:none; 
            border-radius:6px; 
            cursor:pointer; 
            font-size:12px; 
            font-weight:600;
        }
        .btn-edit { background:#ffc107; color:#000;}
        .btn-edit:hover { background:#e0a800;}
        .btn-delete { background:#dc3545; color:white;}
        .btn-delete:hover { background:#c82333;}

        .add-student-section { 
            background:#f8f9fa; 
            padding:20px; 
            border-bottom:2px solid #dee2e6;
        }
        .add-student-section h3 { 
            color:#667eea; 
            margin-bottom:15px; 
            font-size:clamp(16px, 3vw, 18px);
        }
        .form-row { 
            display:flex; 
            gap:10px; 
            flex-wrap:wrap;
        }
        .form-input { 
            padding:10px; 
            border:2px solid #ddd; 
            border-radius:6px; 
            font-size:14px; 
            flex:1; 
            min-width:150px;
        }
        .form-input:focus { 
            outline:none; 
            border-color:#667eea;
        }

        .footer { 
            background:#f8f9fa; 
            padding:20px; 
            text-align:center; 
            border-top:2px solid #dee2e6; 
            color:#666; 
            font-size:clamp(11px, 2vw, 13px);
        }
        .no-results { 
            text-align:center; 
            padding:40px; 
            color:#999; 
            font-size:clamp(14px, 3vw, 18px);
        }

        /* Responsive Improvements */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header { padding: 20px 15px; }
            .header h1 { font-size: 20px; }
            .top-bar {
                flex-direction: column;
                align-items: stretch;
            }
            .term-selector-wrapper {
                width: 100%;
            }
            .language-switcher {
                justify-content: center;
                width: 100%;
            }
            .stats { 
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 15px;
            }
            .controls, .filter-section {
                padding: 15px;
            }
            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }
            .table-wrapper {
                padding: 10px;
            }
            th, td { 
                padding: 8px 5px; 
                font-size: 11px;
            }
            .editable-score {
                min-width: 40px;
                padding: 6px 8px;
            }
            .obs-modern {
                padding: 6px 12px;
                font-size: 11px;
            }
            .action-btn {
                padding: 6px 10px;
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .stats {
                grid-template-columns: 1fr;
            }
            .class-controls {
                flex-direction: column;
            }
            .class-selector,
            .btn {
                width: 100%;
            }
            .filter-buttons {
                flex-direction: column;
            }
            .filter-buttons .btn {
                width: 100%;
            }
        }

        @media print {
            body {background:white; padding:0;}
            .controls, .class-management, .add-student-section, .action-btns, .top-bar, .filter-section {display:none;}
            .container {box-shadow:none; border-radius:0;}
            .table-wrapper { padding: 0; }
            table { min-width: auto; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="top-bar">
            <div class="term-selector-wrapper">
                <label id="termLabel">ğŸ“… Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</label>
                <select id="termSelector" class="term-selector" onchange="switchTerm()">
                    <option value="term1">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</option>
                    <option value="term2">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                    <option value="term3" selected>Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                </select>
            </div>
            <div class="language-switcher">
                <button class="lang-btn active" onclick="changeLanguage('ar')" data-lang="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
                <button class="lang-btn" onclick="changeLanguage('fr')" data-lang="fr">FranÃ§ais</button>
                <button class="lang-btn" onclick="changeLanguage('en')" data-lang="en">English</button>
            </div>
        </div>
        <h1 id="mainTitle">ğŸ“Š Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©</h1>
        <p id="headerSubtitle">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù„Ø« - Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© 2024/2025</p>
    </div>

    <div class="school-settings">
        <h3 id="settingsTitle" style="color:#667eea; margin-bottom:15px; font-size:18px;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h3>
        <div class="settings-grid">
            <input type="text" id="schoolCountry" class="settings-input" placeholder="Ø§Ù„Ø¯ÙˆÙ„Ø©">
            <input type="text" id="schoolMinistry" class="settings-input" placeholder="Ø§Ù„ÙˆØ²Ø§Ø±Ø©">
            <input type="text" id="schoolDirectorate" class="settings-input" placeholder="Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ©">
            <input type="text" id="schoolName" class="settings-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">
        </div>
        <button class="save-settings-btn" id="saveSettingsBtn" onclick="saveSchoolSettings()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>

    <div class="class-management">
        <h3 id="classManagementTitle" style="color:#667eea; margin-bottom:15px; font-size:18px;">ğŸ« Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ø£ÙÙˆØ§Ø¬</h3>
        <div class="class-controls">
            <select id="classSelector" class="class-selector" onchange="switchClass()">
                <option value="" id="selectClassOption">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>
            </select>
            <button class="btn btn-danger" id="deleteClassBtn" onclick="deleteCurrentClass()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
        </div>
        <div class="add-class-section">
            <input type="text" id="newClassName" class="add-class-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
            <button class="btn btn-primary" id="addClassBtn" onclick="addClass()">â• Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯</button>
        </div>
        <div class="classes-list" id="classesList"></div>
    </div>

    <div class="stats">
        <div class="stat-card">
            <div class="stat-label" id="totalStudentsLabel">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°</div>
            <div class="stat-value" id="total-students">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label" id="avgScoreLabel">Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ø§Ù…</div>
            <div class="stat-value" id="avg-score">0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label" id="maxScoreLabel">Ø£Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ù„</div>
            <div class="stat-value" id="max-score">0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label" id="minScoreLabel">Ø£Ø¯Ù†Ù‰ Ù…Ø¹Ø¯Ù„</div>
            <div class="stat-value" id="min-score">0.00</div>
        </div>
    </div>

    <div class="filter-section">
        <h3 id="filterTitle">ğŸ” ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</h3>
        <div class="filter-buttons">
            <button class="btn btn-success" id="excellentBtn" onclick="filterByObservation('excellent')">
                ğŸŒŸ <span id="excellentText">Ù…Ù…ØªØ§Ø²</span>
            </button>
            <button class="btn btn-info" id="verygoodBtn" onclick="filterByObservation('verygood')">
                ğŸ‘ <span id="verygoodText">Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</span>
            </button>
            <button class="btn btn-warning" id="goodBtn" onclick="filterByObservation('good')">
                ğŸ˜Š <span id="goodText">Ø¬ÙŠØ¯</span>
            </button>
            <button class="btn btn-secondary" id="averageBtn" onclick="filterByObservation('average')">
                ğŸ”¶ <span id="averageText">Ù…ØªÙˆØ³Ø·</span>
            </button>
            <button class="btn btn-danger" id="poorBtn" onclick="filterByObservation('poor')">
                âš ï¸ <span id="poorText">ØºÙŠØ± ÙƒØ§ÙÙŠ</span>
            </button>
            <button class="btn btn-primary" id="resetBtn" onclick="resetFilters()">ğŸ”„ <span id="resetText">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</span></button>
        </div>
    </div>

    <div class="controls">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø«..." oninput="searchStudents()">
        </div>
        <button class="btn btn-success" id="exportBtn" onclick="exportToCSV()">ğŸ“¥ <span id="exportText">ØªØµØ¯ÙŠØ±</span></button>
        <button class="btn btn-success" id="printBtn" onclick="window.print()">ğŸ–¨ï¸ <span id="printText">Ø·Ø¨Ø§Ø¹Ø©</span></button>
    </div>

    <div class="add-student-section">
        <h3 id="addStudentTitle">â• Ø¥Ø¶Ø§ÙØ© ØªÙ„Ù…ÙŠØ° Ø¬Ø¯ÙŠØ¯</h3>
        <form onsubmit="addStudent(event)">
            <div class="form-row">
                <input type="text" id="new-lastname" class="form-input" placeholder="Ø§Ù„Ù„Ù‚Ø¨" required>
                <input type="text" id="new-firstname" class="form-input" placeholder="Ø§Ù„Ø§Ø³Ù…" required>
                <button class="btn btn-primary" id="addStudentBtn" type="submit">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
        </form>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr id="tableHeader">
                    <th>#</th>
                    <th id="th-lastname">Ø§Ù„Ù„Ù‚Ø¨</th>
                    <th id="th-firstname">Ø§Ù„Ø§Ø³Ù…</th>
                    <th id="th-oral">Ø§Ù„Ø´ÙÙˆÙŠ</th>
                    <th id="th-reading">Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</th>
                    <th id="th-writing">Ø§Ù„ÙƒØªØ§Ø¨Ø©</th>
                    <th id="th-exam">Ø§Ù„ÙØ±Ø¶</th>
                    <th id="th-average">Ø§Ù„Ù…Ø¹Ø¯Ù„</th>
                    <th id="th-observation">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                    <th id="th-actions">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div id="noResults" class="no-results" style="display:none;">
            <span id="noResultsText">ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</span><br>
            <small id="noResultsHint">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø³Ù… Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© ØªÙ„Ø§Ù…ÙŠØ° Ø¬Ø¯Ø¯</small>
        </div>
    </div>

    <div class="footer">
        <p id="footerText">âœ¨ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ© | Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2025</p>
        <p><span id="printDateLabel">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</span> <span id="printDate"></span></p>
    </div>
</div>

<script>
const STORAGE_KEY = 'studentsGradesSystem';
const SCHOOL_SETTINGS_KEY = 'schoolSettings';
const CLASSES_KEY = 'allClasses';
const LANGUAGE_KEY = 'selectedLanguage';
const TERM_KEY = 'selectedTerm';

let allClassesData = {};
let allClassesList = [];
let currentClass = '';
let currentTerm = 'term3';
let currentLanguage = 'ar';
let studentsData = [];
let filteredData = [];

// Complete translations object with observations
const translations = {
    ar: {
        mainTitle: 'ğŸ“Š Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©',
        headerSubtitle: 'Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© 2024/2025',
        termLabel: 'ğŸ“… Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:',
        term1: 'Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„',
        term2: 'Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ',
        term3: 'Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù„Ø«',
        settingsTitle: 'âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©',
        schoolCountry: 'Ø§Ù„Ø¯ÙˆÙ„Ø©',
        schoolMinistry: 'Ø§Ù„ÙˆØ²Ø§Ø±Ø©',
        schoolDirectorate: 'Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ©',
        schoolName: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©',
        saveSettingsBtn: 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
        classManagementTitle: 'ğŸ« Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ø£ÙÙˆØ§Ø¬',
        selectClassOption: '-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --',
        deleteClassBtn: 'ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ',
        newClassName: 'Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯',
        addClassBtn: 'â• Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯',
        totalStudentsLabel: 'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°',
        avgScoreLabel: 'Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ø§Ù…',
        maxScoreLabel: 'Ø£Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ù„',
        minScoreLabel: 'Ø£Ø¯Ù†Ù‰ Ù…Ø¹Ø¯Ù„',
        filterTitle: 'ğŸ” ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©',
        excellentText: 'Ù…Ù…ØªØ§Ø²',
        verygoodText: 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹',
        goodText: 'Ø¬ÙŠØ¯',
        averageText: 'Ù…ØªÙˆØ³Ø·',
        poorText: 'ØºÙŠØ± ÙƒØ§ÙÙŠ',
        resetText: 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†',
        searchInput: 'ğŸ” Ø§Ø¨Ø­Ø«...',
        exportText: 'ØªØµØ¯ÙŠØ±',
        printText: 'Ø·Ø¨Ø§Ø¹Ø©',
        addStudentTitle: 'â• Ø¥Ø¶Ø§ÙØ© ØªÙ„Ù…ÙŠØ° Ø¬Ø¯ÙŠØ¯',
        lastname: 'Ø§Ù„Ù„Ù‚Ø¨',
        firstname: 'Ø§Ù„Ø§Ø³Ù…',
        addStudentBtn: 'Ø¥Ø¶Ø§ÙØ©',
        thLastname: 'Ø§Ù„Ù„Ù‚Ø¨',
        thFirstname: 'Ø§Ù„Ø§Ø³Ù…',
        thOral: 'Ø§Ù„Ø´ÙÙˆÙŠ',
        thReading: 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©',
        thWriting: 'Ø§Ù„ÙƒØªØ§Ø¨Ø©',
        thExam: 'Ø§Ù„ÙØ±Ø¶',
        thAverage: 'Ø§Ù„Ù…Ø¹Ø¯Ù„',
        thObservation: 'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©',
        thActions: 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª',
        noResultsText: 'ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§',
        noResultsHint: 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø³Ù… Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© ØªÙ„Ø§Ù…ÙŠØ° Ø¬Ø¯Ø¯',
        footerText: 'âœ¨ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ© | Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2025',
        printDateLabel: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:',
        editBtn: 'ØªØ¹Ø¯ÙŠÙ„',
        deleteBtn: 'Ø­Ø°Ù',
        settingsSaved: 'ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­!',
        settingsError: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
        enterClassName: 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…',
        classExists: 'Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!',
        classAdded: 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­!',
        confirmDeleteClass: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…',
        allDataDeleted: 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡!',
        classDeleted: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­!',
        noClassSelected: 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù‚Ø³Ù…',
        selectClassFirst: 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹',
        enterNames: 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù„Ù‚Ø¨ ÙˆØ§Ù„Ø§Ø³Ù…',
        studentAdded: 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ„Ù…ÙŠØ° Ø¨Ù†Ø¬Ø§Ø­!',
        editLastname: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù„Ù‚Ø¨:',
        editFirstname: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…:',
        confirmDeleteStudent: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙ„Ù…ÙŠØ°ØŸ',
        studentDeleted: 'ØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙ„Ù…ÙŠØ° Ø¨Ù†Ø¬Ø§Ø­!',
        noDataToExport: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±',
        invalidScore: 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø¨ÙŠÙ† 0 Ùˆ 10',
        obs_excellent: 'Ù…Ù…ØªØ§Ø²',
        obs_verygood: 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹',
        obs_good: 'Ø¬ÙŠØ¯',
        obs_average: 'Ù…ØªÙˆØ³Ø·',
        obs_poor: 'ØºÙŠØ± ÙƒØ§ÙÙŠ'
    },
    fr: {
        mainTitle: 'ğŸ“Š SystÃ¨me de Gestion des Notes Scolaires',
        headerSubtitle: 'AnnÃ©e Scolaire 2024/2025',
        termLabel: 'ğŸ“… Trimestre:',
        term1: 'Premier Trimestre',
        term2: 'DeuxiÃ¨me Trimestre',
        term3: 'TroisiÃ¨me Trimestre',
        settingsTitle: 'âš™ï¸ ParamÃ¨tres de l\'Ã‰cole',
        schoolCountry: 'Pays',
        schoolMinistry: 'MinistÃ¨re',
        schoolDirectorate: 'Direction',
        schoolName: 'Nom de l\'Ã‰cole',
        saveSettingsBtn: 'ğŸ’¾ Enregistrer',
        classManagementTitle: 'ğŸ« Gestion des Classes',
        selectClassOption: '-- Choisir la Classe --',
        deleteClassBtn: 'ğŸ—‘ï¸ Supprimer la Classe',
        newClassName: 'Nom de la nouvelle classe',
        addClassBtn: 'â• Ajouter une Classe',
        totalStudentsLabel: 'Total Ã‰lÃ¨ves',
        avgScoreLabel: 'Moyenne GÃ©nÃ©rale',
        maxScoreLabel: 'Note Max',
        minScoreLabel: 'Note Min',
        filterTitle: 'ğŸ” Filtrer par Observation',
        excellentText: 'Excellent',
        verygoodText: 'TrÃ¨s Bien',
        goodText: 'Bien',
        averageText: 'Moyen',
        poorText: 'Insuffisant',
        resetText: 'RÃ©initialiser',
        searchInput: 'ğŸ” Rechercher...',
        exportText: 'Exporter',
        printText: 'Imprimer',
        addStudentTitle: 'â• Ajouter un Ã‰lÃ¨ve',
        lastname: 'Nom',
        firstname: 'PrÃ©nom',
        addStudentBtn: 'Ajouter',
        thLastname: 'Nom',
        thFirstname: 'PrÃ©nom',
        thOral: 'Oral',
        thReading: 'Lecture',
        thWriting: 'Ã‰criture',
        thExam: 'Examen',
        thAverage: 'Moyenne',
        thObservation: 'Observation',
        thActions: 'Actions',
        noResultsText: 'ğŸ“­ Aucune DonnÃ©e',
        noResultsHint: 'Veuillez choisir une classe ou ajouter des Ã©lÃ¨ves',
        footerText: 'âœ¨ SystÃ¨me de Gestion des Notes | Tous Droits RÃ©servÃ©s Â© 2025',
        printDateLabel: 'Date d\'Impression:',
        editBtn: 'Modifier',
        deleteBtn: 'Supprimer',
        settingsSaved: 'ParamÃ¨tres enregistrÃ©s avec succÃ¨s!',
        settingsError: 'Erreur lors de l\'enregistrement',
        enterClassName: 'Veuillez entrer le nom de la classe',
        classExists: 'Cette classe existe dÃ©jÃ !',
        classAdded: 'Classe ajoutÃ©e avec succÃ¨s!',
        confirmDeleteClass: 'ÃŠtes-vous sÃ»r de supprimer la classe',
        allDataDeleted: 'Toutes les donnÃ©es seront supprimÃ©es!',
        classDeleted: 'Classe supprimÃ©e avec succÃ¨s!',
        noClassSelected: 'Aucune classe sÃ©lectionnÃ©e',
        selectClassFirst: 'Veuillez d\'abord choisir une classe',
        enterNames: 'Veuillez entrer le nom et le prÃ©nom',
        studentAdded: 'Ã‰lÃ¨ve ajoutÃ© avec succÃ¨s!',
        editLastname: 'Modifier le nom:',
        editFirstname: 'Modifier le prÃ©nom:',
        confirmDeleteStudent: 'ÃŠtes-vous sÃ»r de supprimer cet Ã©lÃ¨ve?',
        studentDeleted: 'Ã‰lÃ¨ve supprimÃ© avec succÃ¨s!',
        noDataToExport: 'Aucune donnÃ©e Ã  exporter',
        invalidScore: 'Veuillez entrer une valeur entre 0 et 10',
        obs_excellent: 'Excellent',
        obs_verygood: 'TrÃ¨s Bien',
        obs_good: 'Bien',
        obs_average: 'Moyen',
        obs_poor: 'Insuffisant'
    },
    en: {
        mainTitle: 'ğŸ“Š School Points Management System',
        headerSubtitle: 'Academic Year 2024/2025',
        termLabel: 'ğŸ“… School Term:',
        term1: 'First Term',
        term2: 'Second Term',
        term3: 'Third Term',
        settingsTitle: 'âš™ï¸ School Settings',
        schoolCountry: 'Country',
        schoolMinistry: 'Ministry',
        schoolDirectorate: 'Directorate',
        schoolName: 'School Name',
        saveSettingsBtn: 'ğŸ’¾ Save Settings',
        classManagementTitle: 'ğŸ« Classes Management',
        selectClassOption: '-- Select Class --',
        deleteClassBtn: 'ğŸ—‘ï¸ Delete Class',
        newClassName: 'New class name',
        addClassBtn: 'â• Add New Class',
        totalStudentsLabel: 'Total Students',
        avgScoreLabel: 'General Average',
        maxScoreLabel: 'Highest Score',
        minScoreLabel: 'Lowest Score',
        filterTitle: 'ğŸ” Filter by Observation',
        excellentText: 'Excellent',
        verygoodText: 'Very Good',
        goodText: 'Good',
        averageText: 'Average',
        poorText: 'Not Enough',
        resetText: 'Reset',
        searchInput: 'ğŸ” Search...',
        exportText: 'Export',
        printText: 'Print',
        addStudentTitle: 'â• Add New Student',
        lastname: 'Last Name',
        firstname: 'First Name',
        addStudentBtn: 'Add',
        thLastname: 'Last Name',
        thFirstname: 'First Name',
        thOral: 'Oral',
        thReading: 'Reading',
        thWriting: 'Writing',
        thExam: 'Exam',
        thAverage: 'Average',
        thObservation: 'Observation',
        thActions: 'Actions',
        noResultsText: 'ğŸ“­ No Data to Display',
        noResultsHint: 'Please select a class or add new students',
        footerText: 'âœ¨ School Points Management System | All Rights Reserved Â© 2025',
        printDateLabel: 'Print Date:',
        editBtn: 'Edit',
        deleteBtn: 'Delete',
        settingsSaved: 'Settings saved successfully!',
        settingsError: 'Error saving settings',
        enterClassName: 'Please enter class name',
        classExists: 'This class already exists!',
        classAdded: 'Class added successfully!',
        confirmDeleteClass: 'Are you sure you want to delete class',
        allDataDeleted: 'All associated data will be deleted!',
        classDeleted: 'Class deleted successfully!',
        noClassSelected: 'No class selected',
        selectClassFirst: 'Please select a class first',
        enterNames: 'Please enter last name and first name',
        studentAdded: 'Student added successfully!',
        editLastname: 'Edit last name:',
        editFirstname: 'Edit first name:',
        confirmDeleteStudent: 'Are you sure you want to delete this student?',
        studentDeleted: 'Student deleted successfully!',
        noDataToExport: 'No data to export',
        invalidScore: 'Please enter a value between 0 and 10',
        obs_excellent: 'Excellent',
        obs_verygood: 'Very Good',
        obs_good: 'Good',
        obs_average: 'Average',
        obs_poor: 'Not Enough'
    }
};

window.onload = function() {
    loadLanguage();
    loadTerm();
    loadSchoolSettings();
    loadAllClasses();
    updatePrintDate();
};

function loadLanguage() {
    const saved = localStorage.getItem(LANGUAGE_KEY);
    if (saved) {
        currentLanguage = saved;
        applyLanguage(currentLanguage);
    }
}

function changeLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem(LANGUAGE_KEY, lang);
    applyLanguage(lang);
}

function applyLanguage(lang) {
    const html = document.documentElement;

    if (lang === 'ar') {
        html.setAttribute('dir', 'rtl');
        html.setAttribute('lang', 'ar');
    } else {
        html.setAttribute('dir', 'ltr');
        html.setAttribute('lang', lang);
    }

    const t = translations[lang];
    document.getElementById('mainTitle').textContent = t.mainTitle;
    document.getElementById('headerSubtitle').textContent = t.headerSubtitle;
    document.getElementById('termLabel').textContent = t.termLabel;
    document.getElementById('settingsTitle').textContent = t.settingsTitle;
    document.getElementById('schoolCountry').placeholder = t.schoolCountry;
    document.getElementById('schoolMinistry').placeholder = t.schoolMinistry;
    document.getElementById('schoolDirectorate').placeholder = t.schoolDirectorate;
    document.getElementById('schoolName').placeholder = t.schoolName;
    document.getElementById('saveSettingsBtn').textContent = t.saveSettingsBtn;
    document.getElementById('classManagementTitle').textContent = t.classManagementTitle;
    document.getElementById('selectClassOption').textContent = t.selectClassOption;
    document.getElementById('deleteClassBtn').textContent = t.deleteClassBtn;
    document.getElementById('newClassName').placeholder = t.newClassName;
    document.getElementById('addClassBtn').textContent = t.addClassBtn;
    document.getElementById('totalStudentsLabel').textContent = t.totalStudentsLabel;
    document.getElementById('avgScoreLabel').textContent = t.avgScoreLabel;
    document.getElementById('maxScoreLabel').textContent = t.maxScoreLabel;
    document.getElementById('minScoreLabel').textContent = t.minScoreLabel;
    document.getElementById('filterTitle').textContent = t.filterTitle;
    document.getElementById('excellentText').textContent = t.excellentText;
    document.getElementById('verygoodText').textContent = t.verygoodText;
    document.getElementById('goodText').textContent = t.goodText;
    document.getElementById('averageText').textContent = t.averageText;
    document.getElementById('poorText').textContent = t.poorText;
    document.getElementById('resetText').textContent = t.resetText;
    document.getElementById('searchInput').placeholder = t.searchInput;
    document.getElementById('exportText').textContent = t.exportText;
    document.getElementById('printText').textContent = t.printText;
    document.getElementById('addStudentTitle').textContent = t.addStudentTitle;
    document.getElementById('new-lastname').placeholder = t.lastname;
    document.getElementById('new-firstname').placeholder = t.firstname;
    document.getElementById('addStudentBtn').textContent = t.addStudentBtn;
    document.getElementById('th-lastname').textContent = t.thLastname;
    document.getElementById('th-firstname').textContent = t.thFirstname;
    document.getElementById('th-oral').textContent = t.thOral;
    document.getElementById('th-reading').textContent = t.thReading;
    document.getElementById('th-writing').textContent = t.thWriting;
    document.getElementById('th-exam').textContent = t.thExam;
    document.getElementById('th-average').textContent = t.thAverage;
    document.getElementById('th-observation').textContent = t.thObservation;
    document.getElementById('th-actions').textContent = t.thActions;
    document.getElementById('noResultsText').textContent = t.noResultsText;
    document.getElementById('noResultsHint').textContent = t.noResultsHint;
    document.getElementById('footerText').textContent = t.footerText;
    document.getElementById('printDateLabel').textContent = t.printDateLabel;

    updateTermSelectorText();

    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-lang') === lang) {
            btn.classList.add('active');
        }
    });

    if (filteredData.length > 0) {
        displayTable(filteredData);
    } else if (studentsData.length > 0) {
        displayTable(studentsData);
    }

    updatePrintDate();
}

function updateTermSelectorText() {
    const selector = document.getElementById('termSelector');
    const options = selector.querySelectorAll('option');
    const t = translations[currentLanguage];

    options[0].textContent = t.term1;
    options[1].textContent = t.term2;
    options[2].textContent = t.term3;
}

function loadTerm() {
    const saved = localStorage.getItem(TERM_KEY);
    if (saved) {
        currentTerm = saved;
        document.getElementById('termSelector').value = currentTerm;
    }
}

function switchTerm() {
    const selector = document.getElementById('termSelector');
    currentTerm = selector.value;
    localStorage.setItem(TERM_KEY, currentTerm);
    loadAllClasses();
}

function getStorageKey() {
    return `${STORAGE_KEY}_${currentTerm}`;
}

function getClassesKey() {
    return `${CLASSES_KEY}_${currentTerm}`;
}

function loadSchoolSettings() {
    try {
        const saved = localStorage.getItem(SCHOOL_SETTINGS_KEY);
        if (saved) {
            const settings = JSON.parse(saved);
            document.getElementById('schoolCountry').value = settings.country || '';
            document.getElementById('schoolMinistry').value = settings.ministry || '';
            document.getElementById('schoolDirectorate').value = settings.directorate || '';
            document.getElementById('schoolName').value = settings.name || '';
        }
    } catch (e) {}
}

function saveSchoolSettings() {
    const settings = {
        country: document.getElementById('schoolCountry').value,
        ministry: document.getElementById('schoolMinistry').value,
        directorate: document.getElementById('schoolDirectorate').value,
        name: document.getElementById('schoolName').value
    };
    try {
        localStorage.setItem(SCHOOL_SETTINGS_KEY, JSON.stringify(settings));
        alert('âœ… ' + translations[currentLanguage].settingsSaved);
    } catch (e) { 
        alert('âŒ ' + translations[currentLanguage].settingsError); 
    }
}

function loadAllClasses() {
    try {
        const savedClasses = localStorage.getItem(getClassesKey());
        if (savedClasses) allClassesList = JSON.parse(savedClasses);
        else allClassesList = [];

        const savedData = localStorage.getItem(getStorageKey());
        if (savedData) allClassesData = JSON.parse(savedData);
        else allClassesData = {};

        updateClassSelector();
        updateClassesList();

        if (allClassesList.length > 0 && !currentClass) {
            currentClass = allClassesList[0];
            document.getElementById('classSelector').value = currentClass;
            switchClass();
        } else displayNoData();
    } catch (e) {
        allClassesList = [];
        allClassesData = {};
        updateClassSelector();
        displayNoData();
    }
}

function saveAllClasses() {
    try {
        localStorage.setItem(getClassesKey(), JSON.stringify(allClassesList));
        localStorage.setItem(getStorageKey(), JSON.stringify(allClassesData));
    } catch (e) { 
        alert('âŒ ' + translations[currentLanguage].settingsError); 
    }
}

function addClass() {
    const input = document.getElementById('newClassName');
    const className = input.value.trim();
    if (!className) { 
        alert('âš ï¸ ' + translations[currentLanguage].enterClassName); 
        return; 
    }
    if (allClassesList.includes(className)) { 
        alert('âš ï¸ ' + translations[currentLanguage].classExists); 
        return; 
    }
    allClassesList.push(className);
    allClassesData[className] = [];
    saveAllClasses();
    updateClassSelector();
    updateClassesList();
    document.getElementById('classSelector').value = className;
    currentClass = className;
    switchClass();
    input.value = '';
    alert('âœ… ' + translations[currentLanguage].classAdded);
}

function deleteCurrentClass() {
    if (!currentClass) { 
        alert('âš ï¸ ' + translations[currentLanguage].noClassSelected); 
        return; 
    }
    if (confirm(translations[currentLanguage].confirmDeleteClass + ' "' + currentClass + '"?\n' + translations[currentLanguage].allDataDeleted)) {
        allClassesList = allClassesList.filter(c => c !== currentClass);
        delete allClassesData[currentClass];
        saveAllClasses();
        currentClass = '';
        updateClassSelector();
        updateClassesList();
        displayNoData();
        alert('âœ… ' + translations[currentLanguage].classDeleted);
    }
}

function updateClassSelector() {
    const selector = document.getElementById('classSelector');
    selector.innerHTML = '<option value="" id="selectClassOption">' + translations[currentLanguage].selectClassOption + '</option>';
    allClassesList.forEach(className => {
        const opt = document.createElement('option');
        opt.value = className;
        opt.textContent = className;
        selector.appendChild(opt);
    });
}

function updateClassesList() {
    const list = document.getElementById('classesList');
    list.innerHTML = '';
    allClassesList.forEach(className => {
        const tag = document.createElement('div');
        tag.className = 'class-tag';
        tag.innerHTML = `${className} <button onclick="deleteClassTag('${className}')">Ã—</button>`;
        list.appendChild(tag);
    });
}

function deleteClassTag(className) {
    if (confirm(translations[currentLanguage].confirmDeleteClass + ' "' + className + '"?\n' + translations[currentLanguage].allDataDeleted)) {
        allClassesList = allClassesList.filter(c => c !== className);
        delete allClassesData[className];
        if (currentClass === className) {
            currentClass = '';
            displayNoData();
        }
        saveAllClasses();
        updateClassSelector();
        updateClassesList();
        alert('âœ… ' + translations[currentLanguage].classDeleted);
    }
}

function switchClass() {
    const selector = document.getElementById('classSelector');
    currentClass = selector.value;
    if (!currentClass) { 
        displayNoData(); 
        return; 
    }
    studentsData = allClassesData[currentClass] || [];
    filteredData = [...studentsData];
    displayTable(filteredData);
    updateStats();
}

function addStudent(event) {
    event.preventDefault();
    if (!currentClass) { 
        alert('âš ï¸ ' + translations[currentLanguage].selectClassFirst); 
        return; 
    }
    const lastname = document.getElementById('new-lastname').value.trim();
    const firstname = document.getElementById('new-firstname').value.trim();
    if (!lastname || !firstname) { 
        alert('âš ï¸ ' + translations[currentLanguage].enterNames); 
        return; 
    }
    const newStudent = {
        id: Date.now(),
        lastname: lastname,
        firstname: firstname,
        oral: 0,
        reading: 0,
        writing: 0,
        exam: 0
    };
    studentsData.push(newStudent);
    allClassesData[currentClass] = studentsData;
    saveAllClasses();
    filteredData = [...studentsData];
    displayTable(filteredData);
    updateStats();
    document.getElementById('new-lastname').value = '';
    document.getElementById('new-firstname').value = '';
    alert('âœ… ' + translations[currentLanguage].studentAdded);
}

function editStudent(id) {
    const student = studentsData.find(s => s.id === id);
    if (!student) return;
    const newLastname = prompt(translations[currentLanguage].editLastname, student.lastname);
    if (newLastname !== null && newLastname.trim()) {
        student.lastname = newLastname.trim();
    }
    const newFirstname = prompt(translations[currentLanguage].editFirstname, student.firstname);
    if (newFirstname !== null && newFirstname.trim()) {
        student.firstname = newFirstname.trim();
    }
    allClassesData[currentClass] = studentsData;
    saveAllClasses();
    filteredData = [...studentsData];
    displayTable(filteredData);
}

function deleteStudent(id) {
    if (confirm(translations[currentLanguage].confirmDeleteStudent)) {
        studentsData = studentsData.filter(s => s.id !== id);
        allClassesData[currentClass] = studentsData;
        saveAllClasses();
        filteredData = [...studentsData];
        displayTable(filteredData);
        updateStats();
        alert('âœ… ' + translations[currentLanguage].studentDeleted);
    }
}

function updateScore(id, field, element) {
    const value = parseFloat(element.textContent);
    if (isNaN(value) || value < 0 || value > 10) {
        alert('âš ï¸ ' + translations[currentLanguage].invalidScore);
        element.textContent = '0.00';
        return;
    }
    const student = studentsData.find(s => s.id === id);
    if (student) {
        student[field] = value;
        allClassesData[currentClass] = studentsData;
        saveAllClasses();
        filteredData = [...studentsData];
        displayTable(filteredData);
        updateStats();
    }
}

function calculateAverage(student) {
    return ((student.oral + student.reading + student.writing + student.exam) / 4).toFixed(2);
}

function getObservation(avg) {
    const t = translations[currentLanguage];
    let obsType, obsText, obsClass, obsIcon;

    if (avg >= 9) {
        obsType = 'excellent';
        obsText = t.obs_excellent;
        obsClass = 'obs-excellent';
        obsIcon = 'ğŸŒŸ';
    } else if (avg >= 7) {
        obsType = 'verygood';
        obsText = t.obs_verygood;
        obsClass = 'obs-verygood';
        obsIcon = 'ğŸ‘';
    } else if (avg >= 5) {
        obsType = 'good';
        obsText = t.obs_good;
        obsClass = 'obs-good';
        obsIcon = 'ğŸ˜Š';
    } else if (avg >= 3) {
        obsType = 'average';
        obsText = t.obs_average;
        obsClass = 'obs-average';
        obsIcon = 'ğŸ”¶';
    } else {
        obsType = 'poor';
        obsText = t.obs_poor;
        obsClass = 'obs-poor';
        obsIcon = 'âš ï¸';
    }

    return {
        type: obsType,
        text: obsText,
        class: obsClass,
        icon: obsIcon
    };
}

function displayTable(data) {
    const tbody = document.getElementById('tableBody');
    const noResults = document.getElementById('noResults');
    const t = translations[currentLanguage];

    if (!data || data.length === 0) {
        tbody.innerHTML = '';
        noResults.style.display = 'block';
        return;
    }

    noResults.style.display = 'none';
    tbody.innerHTML = '';

    data.forEach((student, index) => {
        const avg = calculateAverage(student);
        const obs = getObservation(parseFloat(avg));

        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${index + 1}</strong></td>
            <td class="name-cell">${student.lastname}</td>
            <td class="name-cell">${student.firstname}</td>
            <td>
                <div class="editable-score" 
                     contenteditable="true" 
                     onblur="updateScore(${student.id}, 'oral', this)"
                     onkeypress="if(event.key==='Enter'){this.blur();return false;}">${student.oral.toFixed(2)}</div>
            </td>
            <td>
                <div class="editable-score" 
                     contenteditable="true" 
                     onblur="updateScore(${student.id}, 'reading', this)"
                     onkeypress="if(event.key==='Enter'){this.blur();return false;}">${student.reading.toFixed(2)}</div>
            </td>
            <td>
                <div class="editable-score" 
                     contenteditable="true" 
                     onblur="updateScore(${student.id}, 'writing', this)"
                     onkeypress="if(event.key==='Enter'){this.blur();return false;}">${student.writing.toFixed(2)}</div>
            </td>
            <td>
                <div class="editable-score" 
                     contenteditable="true" 
                     onblur="updateScore(${student.id}, 'exam', this)"
                     onkeypress="if(event.key==='Enter'){this.blur();return false;}">${student.exam.toFixed(2)}</div>
            </td>
            <td><strong>${avg}</strong></td>
            <td>
                <span class="obs-modern ${obs.class}" data-obs-type="${obs.type}">
                    <i>${obs.icon}</i> ${obs.text}
                </span>
            </td>
            <td>
                <div class="action-btns">
                    <button class="action-btn btn-edit" onclick="editStudent(${student.id})">${t.editBtn}</button>
                    <button class="action-btn btn-delete" onclick="deleteStudent(${student.id})">${t.deleteBtn}</button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function displayNoData() {
    const tbody = document.getElementById('tableBody');
    const noResults = document.getElementById('noResults');
    tbody.innerHTML = '';
    noResults.style.display = 'block';
    studentsData = [];
    filteredData = [];
    updateStats();
}

function updateStats() {
    const totalElement = document.getElementById('total-students');
    const avgElement = document.getElementById('avg-score');
    const maxElement = document.getElementById('max-score');
    const minElement = document.getElementById('min-score');

    if (studentsData.length === 0) {
        totalElement.textContent = '0';
        avgElement.textContent = '0.00';
        maxElement.textContent = '0.00';
        minElement.textContent = '0.00';
        return;
    }

    const averages = studentsData.map(s => parseFloat(calculateAverage(s)));
    const total = studentsData.length;
    const avg = (averages.reduce((a, b) => a + b, 0) / total).toFixed(2);
    const max = Math.max(...averages).toFixed(2);
    const min = Math.min(...averages).toFixed(2);

    totalElement.textContent = total;
    avgElement.textContent = avg;
    maxElement.textContent = max;
    minElement.textContent = min;
}

function searchStudents() {
    const query = document.getElementById('searchInput').value.toLowerCase().trim();
    if (!query) {
        filteredData = [...studentsData];
    } else {
        filteredData = studentsData.filter(s => 
            s.lastname.toLowerCase().includes(query) || 
            s.firstname.toLowerCase().includes(query)
        );
    }
    displayTable(filteredData);
}

function filterByObservation(obsType) {
    filteredData = studentsData.filter(student => {
        const avg = parseFloat(calculateAverage(student));
        const obs = getObservation(avg);
        return obs.type === obsType;
    });
    displayTable(filteredData);
}

function resetFilters() {
    document.getElementById('searchInput').value = '';
    filteredData = [...studentsData];
    displayTable(filteredData);
}

function exportToCSV() {
    if (!filteredData || filteredData.length === 0) {
        alert('âš ï¸ ' + translations[currentLanguage].noDataToExport);
        return;
    }

    const t = translations[currentLanguage];
    let csv = `${t.thLastname},${t.thFirstname},${t.thOral},${t.thReading},${t.thWriting},${t.thExam},${t.thAverage},${t.thObservation}\n`;

    filteredData.forEach(student => {
        const avg = calculateAverage(student);
        const obs = getObservation(parseFloat(avg));
        csv += `${student.lastname},${student.firstname},${student.oral},${student.reading},${student.writing},${student.exam},${avg},${obs.text}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${currentClass}_${currentTerm}_students.csv`;
    link.click();
}

function updatePrintDate() {
    const now = new Date();
    const dateStr = now.toLocaleDateString(currentLanguage === 'ar' ? 'ar-DZ' : currentLanguage === 'fr' ? 'fr-FR' : 'en-US');
    document.getElementById('printDate').textContent = dateStr;
}
</script>
</body>
</html>